
NFS provides the same purpose as SMB does which is to share folders on a network as if they were local to your system. 

NFS utilizes an entirely different protocol than SMB does. 
	- NFS is used throughout UNIX and Linux systems, which means that NFS clients cannot directly communicate with SMB servers. 

| Version | Features                                                                                                                                                                                                                                  |
| ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| NFSv2   | It is an older version but is still supported by many systems today.                                                                                                                                                                      |
| NFSv3   | Includes more features than previous version, including variable file size and better error reporting, but is not fully compatible with NFSv2 client.                                                                                     |
| NFSv4   | Includes kerberos, works through firewalls and on the internet, no longer requires portmappers, supports ACLs, applies state-based operations, and provides performance improvements and high security. First to use a stateful protocol. |
NFSv4.1 provides support to leverage cluster server deployments, including the ability to provide scalable parallel access to files distributed across multiple servers (pNFS extension). 
	- Also includes a trunking mechanism, known as NFS multipathing
	- Only one UDP or TCP port 2049 is used to run the service. 

**Default Configurations**

- NFS utilizes the /etc/exports file that contains a table of physical filesystems on an NFS server accessible by clients.

```shell-session
realCustampin@htb[/htb]$ cat /etc/exports 

# /etc/exports: the access control list for filesystems which may be exported
#               to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
```

NFS Configuration Options

| Option           | Description                                                                                                                                   |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| rw               | Read and write persmissions                                                                                                                   |
| ro               | Read only permissions                                                                                                                         |
| sync             | Synchronous data transfer                                                                                                                     |
| async            | Asynchronous data transfer                                                                                                                    |
| secure           | Ports above 1024 will not be used                                                                                                             |
| insecure         | Ports above 1024 will be used                                                                                                                 |
| no_subtree_check | This option disables the checking of subdirectory trees.                                                                                      |
| root_squash      | Assigns all permissions to files of root UID/GID 0 to the UID/GID of anonymous, which prevents **root** from accessing files on an NFS mount. |
**Dangerous Settings**

Below are some examples of potentially dangerous for the company and its infrastructure.  

| Option         | Description                                                                                                         |
| -------------- | ------------------------------------------------------------------------------------------------------------------- |
| rw             | Read and write permissions                                                                                          |
| insecure       | ports above 1024 will be used                                                                                       |
| nohide         | If another file system was mounted below an exported directory, this directory is exported by its own exports entry |
| no_root_squash | All files created by root are kept with the UID/GID 0.                                                              |
**Footprinting the Service**
- When footprinting the service, we must conduct a scan on ports 111 and 2049. Lets look at an example of what an NMAP scan may look like. 
```shell-session
realCustampin@htb[/htb]$ sudo nmap 10.129.14.128 -p111,2049 -sV -sC

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 17:12 CEST
Nmap scan report for 10.129.14.128
Host is up (0.00018s latency).

PORT    STATE SERVICE VERSION
111/tcp open  rpcbind 2-4 (RPC #100000)
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      41982/udp6  mountd
|   100005  1,2,3      45837/tcp   mountd
|   100005  1,2,3      47217/tcp6  mountd
|   100005  1,2,3      58830/udp   mountd
|   100021  1,3,4      39542/udp   nlockmgr
|   100021  1,3,4      44629/tcp   nlockmgr
|   100021  1,3,4      45273/tcp6  nlockmgr
|   100021  1,3,4      47524/udp6  nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
2049/tcp open  nfs_acl 3 (RPC #100227)
MAC Address: 00:00:00:00:00:00 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.58 seconds
```

The rpcinfo NSE script retrieves a list of all current RPC services. Also NMAP has certain NSE scripts that can scan for the contents of the shares. 


```shell-session
realCustampin@htb[/htb]$ sudo nmap --script nfs* 10.129.14.128 -sV -p111,2049

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 17:37 CEST
Nmap scan report for 10.129.14.128
Host is up (0.00021s latency).

PORT     STATE SERVICE VERSION
111/tcp  open  rpcbind 2-4 (RPC #100000)
| nfs-ls: Volume /mnt/nfs
|   access: Read Lookup NoModify NoExtend NoDelete NoExecute
| PERMISSION  UID    GID    SIZE  TIME                 FILENAME
| rwxrwxrwx   65534  65534  4096  2021-09-19T15:28:17  .
| ??????????  ?      ?      ?     ?                    ..
| rw-r--r--   0      0      1872  2021-09-19T15:27:42  id_rsa
| rw-r--r--   0      0      348   2021-09-19T15:28:17  id_rsa.pub
| rw-r--r--   0      0      0     2021-09-19T15:22:30  nfs.share
|_
| nfs-showmount: 
|_  /mnt/nfs 10.129.14.0/24
| nfs-statfs: 
|   Filesystem  1K-blocks   Used       Available   Use%  Maxfilesize  Maxlink
|_  /mnt/nfs    30313412.0  8074868.0  20675664.0  29%   16.0T        32000
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      41982/udp6  mountd
|   100005  1,2,3      45837/tcp   mountd
|   100005  1,2,3      47217/tcp6  mountd
|   100005  1,2,3      58830/udp   mountd
|   100021  1,3,4      39542/udp   nlockmgr
|   100021  1,3,4      44629/tcp   nlockmgr
|   100021  1,3,4      45273/tcp6  nlockmgr
|   100021  1,3,4      47524/udp6  nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
2049/tcp open  nfs_acl 3 (RPC #100227)
MAC Address: 00:00:00:00:00:00 (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 0.45 seconds
```

Once we have discovered such an NFS service, we can then mount that share onto our local machine. 
	- Create an empty folder which the NFS share will be mounted to. 

One way to view the available shares we can utilize the command below: 
```shell-session
realCustampin@htb[/htb]$ showmount -e 10.129.14.128

Export list for 10.129.14.128:
/mnt/nfs 10.129.14.0/24
```

Once we get our target NFS, we can then mount the Network File System to our new folder that we have created, and then look at the contents within the folder. 
```shell-session
realCustampin@htb[/htb]$ mkdir target-NFS
realCustampin@htb[/htb]$ sudo mount -t nfs 10.129.14.128:/ ./target-NFS/ -o nolock
realCustampin@htb[/htb]$ cd target-NFS
realCustampin@htb[/htb]$ tree .

.
└── mnt
    └── nfs
        ├── id_rsa
        ├── id_rsa.pub
        └── nfs.share

2 directories, 3 file
```

It is important to note that if the root_squash option is set, we cannot edit the backup.sh file even as root. 

**Unmounting the NFS**

If we would like to unmount the target NFS then we can use the unmount command. 
```shell-session
realCustampin@htb[/htb]$ cd ..
realCustampin@htb[/htb]$ sudo umount ./target-NFS
```

