Server Message Block

Quick Breakdown: 
	- Client-Server protocol
	- Regulates access to files and directories
	- Also regulates access to network resources. 

Main application area has been Windows operating system. 
	- Incorporates a downward-compatible manner meaning that newer editions can easily communicate with older editions. 

With Samba, this allows communication between UNIX and Linux distros and Windows OS. 

SMB Server can provide arbitrary parts of the local file system as shares (SMB Shares). Knowing this information, we know that the file structure that is being shown on the server is not all of the files on the client. 
	- Access rights can be granted by ACLs


**SAMBA**
	- Samba is an SMB server that is primarily used on UNIX systems. 
	- Implements the use of the CIFS (Common Internet File System) network protocol
	- Using CIFS allows Samba to communicate effectively with newer Windows OS's. 

CIFS is a specific version of the SMB protocol, primarily utilized in SMB version 1 exclusively. 

When using SMBv1 it utilizes the older NetBIOS service, which occur over TCP ports 137, 138, and 139. 

If utilizing CIFS, it operates over port 445 exclusively. 


| SMB Version | Supported                           | Features                                                               |
| ----------- | ----------------------------------- | ---------------------------------------------------------------------- |
| CIFS        | Windows NT 4.0                      | Communication via NetBIOS interface                                    |
| SMB 1.0     | Windows 2000                        | Direct connection via TCP                                              |
| SMB 2.0     | Windows Vista, Windows Server 2008  | Performance upgrades, improved message signing, caching feature        |
| SMB 2.1     | Windows 7, Windows Server 2008 R2   | Locking mechanisms                                                     |
| SMB 3.0     | Windows 8, Windows Server 2012      | Multichannel connections, end-to-end encryption, remote storage access |
| SMB 3.0.2   | Windows 8.1, Windows Server 2012 R2 |                                                                        |
| SMB 3.1.1   | Windows 10, Windows Server 2016     | Integrity checking, AES-128 encryption                                 |

Some shares can be compliant with global settings and then others can use a specific set of settings defined by individual shares. 

	

| Setting                      | Description                                                           |
| ---------------------------- | --------------------------------------------------------------------- |
| [sharename]                  | The name of the network share.                                        |
| workgroup = WORKGROUP/DOMAIN | Workgroup that will appear when clients query.                        |
| path =path/here/             | The directory to which user is to be given access.                    |
| server string = STRING       | The string that will show up when a connection is initiated.          |
| unix password sync = yes     | Synchronize the UNIX password with the SMB pass                       |
| usershare allow guests = yes | Allow non-authenticated users to access defined share                 |
| map to guest = bad user      | What to do when a user login request doesn't match a valid UNIX user. |
| browseable = yes             | Should this share be shown in the list of available shares?           |
| guest ok = yes               | Allow connecting to the service without a password?                   |
| read only = yes              | Allow users to read files only?                                       |
| create mask = 0700           | What permissions need to be set for newly created files               |

**Dangerous Settings**

These settings listed below are settings that we are looking for when enumerating an SMB service. 

| Setting                   | Description                                                         |
| ------------------------- | ------------------------------------------------------------------- |
| browseable = yes          | Should this share be shown in the list of available shares?         |
| guest ok = yes            | Allow connecting to the service without a password?                 |
| read only = no            | Allow users to read files only?                                     |
| create mask = 0777        | What permissions need to be set for newly created files             |
| enable privilages = yes   | Honor priviliges assigned to specific SID?                          |
| directory mask = 0777     | What permissions must be assigned to the newly created directories. |
| login script = script.sh  | what script needs to be executed on the user's login?               |
| magic script = script.sh  | Which script should be executed when the script gets closed?        |
| magic output = script.out | Where the output of the magi script needs to be stored?             |
**Location of SMB.conf**
 `/etc/samba/smb.conf`

**Downloading Files from SMB**
	- We can utilize the "get" command to grab any files that may be available in the share. 
```shell-session
smb: \> get prep-prod.txt 

getting file \prep-prod.txt of size 71 as prep-prod.txt (8,7 KiloBytes/sec) 
(average 8,7 KiloBytes/sec)


smb: \> !ls

prep-prod.txt


smb: \> !cat prep-prod.txt

[] check your code with the templates
[] run code-assessment.py
[] …	
```

From an admin POV we can check active connections using the "smbstatus" command that is available to us. This allows us to view: 
	- Who 
	- From which host
	- Which share the client is connected to. 

For domain-level security, the samba server acts as a member of a windows domain. Each domain has at least one domain controller, which is providing password authentication. Domain controllers keep track of users and passwords in their own NTDS.dit and Security Authentication Module (SAM) and can authenticate each user when they log in for the first time. 

```shell-session
root@samba:~# smbstatus

Samba version 4.11.6-Ubuntu
PID     Username     Group        Machine                                   Protocol Version  Encryption           Signing              
----------------------------------------------------------------------------------------------------------------------------------------
75691   sambauser    samba        10.10.14.4 (ipv4:10.10.14.4:45564)      SMB3_11           -                    -                    

Service      pid     Machine       Connected at                     Encryption   Signing     
---------------------------------------------------------------------------------------------
notes        75691   10.10.14.4   Do Sep 23 00:12:06 2021 CEST     -            -           

No locked files
```

**Footprinting the Service**

Let us use NMAP for example, we can utilize NMAP and the NSE scripts to footprint around SMB however that takes up a lot of time and doesn't really give us all that great of information. 

```shell-session
realCustampin@htb[/htb]$ sudo nmap 10.129.14.128 -sV -sC -p139,445

Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 15:15 CEST
Nmap scan report for sharing.inlanefreight.htb (10.129.14.128)
Host is up (0.00024s latency).

PORT    STATE SERVICE     VERSION
139/tcp open  netbios-ssn Samba smbd 4.6.2
445/tcp open  netbios-ssn Samba smbd 4.6.2
MAC Address: 00:00:00:00:00:00 (VMware)

Host script results:
|_nbstat: NetBIOS name: HTB, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2021-09-19T13:16:04
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.35 seconds
```

Given that these results aren't the best, we have to resort to manually interacting with SMB in order to send specific requests for the information. One tool that we can utilize is **rpcclient.** This is a tool to perform MS-RPC functions. 

Remote Procedure Call is a concept and, therefore, also a central tool to realize operational and work-sharing structure in networks. 

```shell-session
realCustampin@htb[/htb]$ rpcclient -U "" 10.129.14.128

Enter WORKGROUP\'s password:
rpcclient $> 
```

MAN Page for SAMBA: https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html

rpcclient offers many different types of requests that we can pass in order to gain more information about the server. 


| Query                   | Description                                                        |
| ----------------------- | ------------------------------------------------------------------ |
| srvinfo                 | Server Information                                                 |
| enumdomains             | Enumerate all domains that are deployed in the network.            |
| querydominfo            | Provides domain, server, and user information of deployed domains. |
| netshareenumall         | Enumerate all available shares                                     |
| netsharegetinfo "share" | provides info about a specific share                               |
| enumdomusers            | Enumerate all domain users                                         |
| queryuser "RID"         | Provides information about a specific user.                        |
Listed below are some examples of what you would see when utilizing some of these commands. 

```shell-session
rpcclient $> srvinfo

        DEVSMB         Wk Sv PrQ Unx NT SNT DEVSM
        platform_id     :       500
        os version      :       6.1
        server type     :       0x809a03
		
		
rpcclient $> enumdomains

name:[DEVSMB] idx:[0x0]
name:[Builtin] idx:[0x1]


rpcclient $> querydominfo

Domain:         DEVOPS
Server:         DEVSMB
Comment:        DEVSM
Total Users:    2
Total Groups:   0
Total Aliases:  0
Sequence No:    1632361158
Force Logoff:   -1
Domain Server State:    0x1
Server Role:    ROLE_DOMAIN_PDC
Unknown 3:      0x1


rpcclient $> netshareenumall

netname: print$
        remark: Printer Drivers
        path:   C:\var\lib\samba\printers
        password:
netname: home
        remark: INFREIGHT Samba
        path:   C:\home\
        password:
netname: dev
        remark: DEVenv
        path:   C:\home\sambauser\dev\
        password:
netname: notes
        remark: CheckIT
        path:   C:\mnt\notes\
        password:
netname: IPC$
        remark: IPC Service (DEVSM)
        path:   C:\tmp
        password:
		
		
rpcclient $> netsharegetinfo notes

netname: notes
        remark: CheckIT
        path:   C:\mnt\notes\
        password:
        type:   0x0
        perms:  0
        max_uses:       -1
        num_uses:       1
revision: 1
type: 0x8004: SEC_DESC_DACL_PRESENT SEC_DESC_SELF_RELATIVE 
DACL
        ACL     Num ACEs:       1       revision:       2
        ---
        ACE
                type: ACCESS ALLOWED (0) flags: 0x00 
                Specific bits: 0x1ff
                Permissions: 0x101f01ff: Generic all access SYNCHRONIZE_ACCESS WRITE_OWNER_ACCESS WRITE_DAC_ACCESS READ_CONTROL_ACCESS DELETE_ACCESS 
                SID: S-1-1-0
```


Rpcclient User Enumeration
	- Using the enumdomusers command, we can see that this gives us a list of the domain users on the share. 

```shell-session
rpcclient $> enumdomusers

user:[mrb3n] rid:[0x3e8]
user:[cry0l1t3] rid:[0x3e9]


rpcclient $> queryuser 0x3e9

        User Name   :   cry0l1t3
        Full Name   :   cry0l1t3
        Home Drive  :   \\devsmb\cry0l1t3
        Dir Drive   :
        Profile Path:   \\devsmb\cry0l1t3\profile
        Logon Script:
        Description :
        Workstations:
        Comment     :
        Remote Dial :
        Logon Time               :      Do, 01 Jan 1970 01:00:00 CET
        Logoff Time              :      Mi, 06 Feb 2036 16:06:39 CET
        Kickoff Time             :      Mi, 06 Feb 2036 16:06:39 CET
        Password last set Time   :      Mi, 22 Sep 2021 17:50:56 CEST
        Password can change Time :      Mi, 22 Sep 2021 17:50:56 CEST
        Password must change Time:      Do, 14 Sep 30828 04:48:05 CEST
        unknown_2[0..31]...
        user_rid :      0x3e9
        group_rid:      0x201
        acb_info :      0x00000014
        fields_present: 0x00ffffff
        logon_divs:     168
        bad_password_count:     0x00000000
        logon_count:    0x00000000
        padding1[0..7]...
        logon_hrs[0..21]...


rpcclient $> queryuser 0x3e8

        User Name   :   mrb3n
        Full Name   :
        Home Drive  :   \\devsmb\mrb3n
        Dir Drive   :
        Profile Path:   \\devsmb\mrb3n\profile
        Logon Script:
        Description :
        Workstations:
        Comment     :
        Remote Dial :
        Logon Time               :      Do, 01 Jan 1970 01:00:00 CET
        Logoff Time              :      Mi, 06 Feb 2036 16:06:39 CET
        Kickoff Time             :      Mi, 06 Feb 2036 16:06:39 CET
        Password last set Time   :      Mi, 22 Sep 2021 17:47:59 CEST
        Password can change Time :      Mi, 22 Sep 2021 17:47:59 CEST
        Password must change Time:      Do, 14 Sep 30828 04:48:05 CEST
        unknown_2[0..31]...
        user_rid :      0x3e8
        group_rid:      0x201
        acb_info :      0x00000010
        fields_present: 0x00ffffff
        logon_divs:     168
        bad_password_count:     0x00000000
        logon_count:    0x00000000
        padding1[0..7]...
        logon_hrs[0..21]...
```

This gives us a lot of information including the Group's RID, which we can then use to query and gather more information from the entire group. 

```shell-session
rpcclient $> querygroup 0x201

        Group Name:     None
        Description:    Ordinary Users
        Group Attribute:7
        Num Members:2
```

We can utilize the rpcclient to brute force the RIDs to get information. We can create a For-loop using Bash where we send a command to the service using rpcclient and filter the results. 
```shell-session
realCustampin@htb[/htb]$ for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done

        User Name   :   sambauser
        user_rid :      0x1f5
        group_rid:      0x201
		
        User Name   :   mrb3n
        user_rid :      0x3e8
        group_rid:      0x201
		
        User Name   :   cry0l1t3
        user_rid :      0x3e9
        group_rid:      0x201
```

We can also utilize Open-Source python scripts, for example the Samrdump.py

https://github.com/fortra/impacket/blob/master/examples/samrdump.py

```shell-session
realCustampin@htb[/htb]$ samrdump.py 10.129.14.128

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Retrieving endpoint list from 10.129.14.128
Found domain(s):
 . DEVSMB
 . Builtin
[*] Looking up users in domain DEVSMB
Found user: mrb3n, uid = 1000
Found user: cry0l1t3, uid = 1001
mrb3n (1000)/FullName: 
mrb3n (1000)/UserComment: 
mrb3n (1000)/PrimaryGroupId: 513
mrb3n (1000)/BadPasswordCount: 0
mrb3n (1000)/LogonCount: 0
mrb3n (1000)/PasswordLastSet: 2021-09-22 17:47:59
mrb3n (1000)/PasswordDoesNotExpire: False
mrb3n (1000)/AccountIsDisabled: False
mrb3n (1000)/ScriptPath: 
cry0l1t3 (1001)/FullName: cry0l1t3
cry0l1t3 (1001)/UserComment: 
cry0l1t3 (1001)/PrimaryGroupId: 513
cry0l1t3 (1001)/BadPasswordCount: 0
cry0l1t3 (1001)/LogonCount: 0
cry0l1t3 (1001)/PasswordLastSet: 2021-09-22 17:50:56
cry0l1t3 (1001)/PasswordDoesNotExpire: False
cry0l1t3 (1001)/AccountIsDisabled: False
cry0l1t3 (1001)/ScriptPath: 
[*] Received 2 entries.
```

The information that we have obtained from rpcclient can als be obatined using SMBMap or CrackMapExec. 

SMBMap:
```shell-session
realCustampin@htb[/htb]$ smbmap -H 10.129.14.128

[+] Finding open SMB ports....
[+] User SMB session established on 10.129.14.128...
[+] IP: 10.129.14.128:445       Name: 10.129.14.128                                     
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        print$                                                  NO ACCESS       Printer Drivers
        home                                                    NO ACCESS       INFREIGHT Samba
        dev                                                     NO ACCESS       DEVenv
        notes                                                   NO ACCESS       CheckIT
        IPC$                                                    NO ACCESS       IPC Service (DEV
```

CrackMapExec: 
```shell-session
realCustampin@htb[/htb]$ crackmapexec smb 10.129.14.128 --shares -u '' -p ''

SMB         10.129.14.128   445    DEVSMB           [*] Windows 6.1 Build 0 (name:DEVSMB) (domain:) (signing:False) (SMBv1:False)
SMB         10.129.14.128   445    DEVSMB           [+] \: 
SMB         10.129.14.128   445    DEVSMB           [+] Enumerated shares
SMB         10.129.14.128   445    DEVSMB           Share           Permissions     Remark
SMB         10.129.14.128   445    DEVSMB           -----           -----------     ------
SMB         10.129.14.128   445    DEVSMB           print$                          Printer Drivers
SMB         10.129.14.128   445    DEVSMB           home                            INFREIGHT Samba
SMB         10.129.14.128   445    DEVSMB           dev                             DEVenv
SMB         10.129.14.128   445    DEVSMB           notes           READ,WRITE      CheckIT
SMB         10.129.14.128   445    DEVSMB           IPC$
```


Another tool that we can use for an overall view of the IP is enum4linux-ng, which is based on an older tool, enum4linux. 

Installation: 
```shell-session
realCustampin@htb[/htb]$ git clone https://github.com/cddmp/enum4linux-ng.git
realCustampin@htb[/htb]$ cd enum4linux-ng
realCustampin@htb[/htb]$ pip3 install -r requirements.txt
```

enum4linux-ng example: 
```shell-session
realCustampin@htb[/htb]$ ./enum4linux-ng.py 10.129.14.128 -A

ENUM4LINUX - next generation

 ==========================
|    Target Information    |
 ==========================
[*] Target ........... 10.129.14.128
[*] Username ......... ''
[*] Random Username .. 'juzgtcsu'
[*] Password ......... ''
[*] Timeout .......... 5 second(s)

 =====================================
|    Service Scan on 10.129.14.128    |
 =====================================
[*] Checking LDAP
[-] Could not connect to LDAP on 389/tcp: connection refused
[*] Checking LDAPS
[-] Could not connect to LDAPS on 636/tcp: connection refused
[*] Checking SMB
[+] SMB is accessible on 445/tcp
[*] Checking SMB over NetBIOS
[+] SMB over NetBIOS is accessible on 139/tcp

 =====================================================
|    NetBIOS Names and Workgroup for 10.129.14.128    |
 =====================================================
[+] Got domain/workgroup name: DEVOPS
[+] Full NetBIOS names information:
- DEVSMB          <00> -         H <ACTIVE>  Workstation Service
- DEVSMB          <03> -         H <ACTIVE>  Messenger Service
- DEVSMB          <20> -         H <ACTIVE>  File Server Service
- ..__MSBROWSE__. <01> - <GROUP> H <ACTIVE>  Master Browser
- DEVOPS          <00> - <GROUP> H <ACTIVE>  Domain/Workgroup Name
- DEVOPS          <1d> -         H <ACTIVE>  Master Browser
- DEVOPS          <1e> - <GROUP> H <ACTIVE>  Browser Service Elections
- MAC Address = 00-00-00-00-00-00

 ==========================================
|    SMB Dialect Check on 10.129.14.128    |
 ==========================================
[*] Trying on 445/tcp
[+] Supported dialects and settings:
SMB 1.0: false
SMB 2.02: true
SMB 2.1: true
SMB 3.0: true
SMB1 only: false
Preferred dialect: SMB 3.0
SMB signing required: false
```

Standard procedures want you to utilize more than two tools because all tools are created differently, which also can mean that they share different information. 


